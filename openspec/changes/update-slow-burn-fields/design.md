## Context

本次变更涉及项目管理系统中慢燃项目（slow-burn）的数据模型重构，包括：
1. 项目类型重命名（breaking change）
2. 新增指标系统数据结构
3. 时间展示格式统一
4. 引入 Tiptap 富文本编辑器替代现有方案

## Goals / Non-Goals

### Goals
- 准确表达 slow-burn 项目的"有目的积累"特性
- 为 slow-burn 项目提供多维度进度追踪能力
- 提供优秀的 Markdown 编辑体验
- 统一时间展示格式

### Non-Goals
- 不改变 sprint-project 的行为
- 不添加指标历史记录功能
- 不实现实时协作编辑
- 不使用数据库存储 Tiptap 编辑器状态（仍存 Markdown 纯文本）

## Decisions

### Decision 1: 项目类型重命名策略
**Decision**: 直接重命名，不保留向后兼容
**Rationale**: 
- 这是个人使用系统，数据量小
- 一次性迁移脚本可以处理所有现有数据
- 避免维护两套类型标识的复杂度

### Decision 2: 指标数据结构
**Decision**: 使用 JSONB 存储 indicators 数组
**Rationale**:
- 指标数量少（1-10个），结构相对固定
- 不需要单独查询或索引指标
- 与项目数据一起存储减少 JOIN 操作

**数据结构**:
```typescript
interface ProjectIndicator {
  id: string;      // uuid
  name: string;    // max 50 chars
  value: number;   // current value, >= 0
  target: number;  // target value, > 0
  weight: number;  // 0-100, sum of all weights = 100
}
```

### Decision 3: 进度计算公式
**Decision**: 
```
singleIndicatorProgress = min(100%, (value / target) * 100%)
totalProgress = Σ(singleIndicatorProgress * weight) / 100
```
**Rationale**:
- 单个指标完成度上限 100%，防止超额完成影响权重平衡
- 加权平均计算总进度，反映各指标重要性
- 结果范围 0%-100%，易于理解

**边界处理**:
| 场景 | 处理方式 |
|------|----------|
| target = 0 | 完成度视为 0% |
| value >= target | 完成度视为 100% |
| value < 0 | 按 0 处理 |
| 无指标 | 进度显示为 0% 或隐藏 |

---

### Decision 6: 前端交互逻辑与布局

#### 6.1 项目表单布局变化

**表单结构调整**:

```
┌────────────────────────────────────────────────────────┐
│ 项目名称                                               │
│ [输入框]                                              │
├────────────────────────────────────────────────────────┤
│ 项目类型                                               │
│ [下拉选择器: 冲刺项目 | 慢燃项目]                        │
├────────────────────────────────────────────────────────┤
│ 优先级                    积分                         │
│ [低/中/高]                [自动计算/手动输入]            │
├────────────────────────────────────────────────────────┤
│ 项目状态                                               │
│ [规划中/进行中/已完成/暂停]                             │
├────────────────────────────────────────────────────────┤
│ 开始时间                                               │
│ [日期选择器]                                          │
├────────────────────────────────────────────────────────┤
│ ← 此时根据项目类型分支 →                                │
├────────────────────────────────────────────────────────┤
│ 如果选择"冲刺项目":          │ 如果选择"慢燃项目":        │
│                          │                          │
│ 结束时间                   │ 积累指标                  │
│ [日期选择器]               │ ┌────────────────────┐  │
│                          │ │ 指标名称 | 目标值 | 权重 │  │
│                          │ │ ───────────────────│  │
│                          │ │ 阅读页数 | 300   | 60 │  │
│                          │ │ 笔记数量 | 50    | 40 │  │
│                          │ │                    │  │
│                          │ │ [+ 添加指标]        │  │
│                          │ │ 总权重: 100% ✓     │  │
│                          │ │ 当前进度: 38%      │  │
│                          │ └────────────────────┘  │
├────────────────────────────────────────────────────────┤
│ 项目描述                                               │
│ [Markdown编辑器 - 默认4行]                              │
└────────────────────────────────────────────────────────┘
```

**布局说明**:
- 选择慢燃项目后，结束时间字段被移除
- 移除的结束时间位置被"积累指标"区域替代
- 积累指标区域与描述区域之间保持适当间距（space-y-6）

#### 6.1.1 Drawer 滚动区域布局稳定性

**问题**：切换为慢燃项目时，积累指标区域出现导致 Drawer 内容高度超出视口，滚动条随即出现，占用约 17px 宽度，造成内容区域向左偏移的视觉抖动。

**Decision**: 在 Drawer 可滚动内容区域添加 `scrollbar-gutter: stable`
**Rationale**:
- `scrollbar-gutter: stable` 会在滚动条出现之前预留其宽度，防止内容在滚动条显示/隐藏时发生位移
- 对于不需要滚动时，虽然保留了空白区域，但在宽度固定的 Drawer（600px）内视觉影响可忽略
- 现代浏览器（Chrome 94+, Firefox 97+, Safari 15.4+）均已支持

**实现**:
```html
<!-- Drawer 内容区域 -->
<div class="flex-1 overflow-y-auto p-6 [scrollbar-gutter:stable]">
```

#### 6.2 指标管理交互

**添加指标流程**:
1. 用户点击"+ 添加指标"按钮
2. 系统在列表底部插入新的空指标行
3. 新行自动获得焦点，聚焦"指标名称"输入框
4. 用户依次填写：指标名称 → 目标值 → 当前值 → 权重
5. 填写过程中，实时计算并显示总权重

**编辑指标流程**:
1. 用户点击任意指标行的输入框
2. 字段变为可编辑状态（无需切换模式）
3. 修改后自动触发权重总和校验
4. 权重不等于 100% 时显示红色警告

**删除指标流程**:
1. 用户点击指标行右侧的删除按钮（🗑️）
2. 系统显示确认提示：「确定删除此指标吗？」
3. 用户确认后，该行被移除
4. 系统重新计算总权重并更新进度预览
5. 剩余指标行重新编号

**权重校验交互**:
| 总权重状态 | UI 反馈 |
|------------|----------|
| = 100% | 显示绿色 ✓，允许提交 |
| < 100% | 显示红色警告「还差 X%」，阻止提交 |
| > 100% | 显示红色警告「超出 X%」，阻止提交 |

#### 6.3 进度预览

**实时预览区域**:
- 位于指标列表下方、「添加指标」按钮上方
- 显示格式：「当前进度：38% ████░░░░░░」
- 进度条颜色：根据进度值变化（0-30% 红色，31-70% 黄色，71-100% 绿色）
- 每次指标 value/target/weight 变化时自动更新

**计算时机**:
- 用户输入 value 时实时计算
- 用户输入 target 时实时计算  
- 用户调整 weight 时实时计算
- 指标添加/删除后重新计算

#### 6.4 项目卡片展示

**Slow-burn 项目卡片布局**:
```
┌────────────────────────────────────────┐
│ 🌱 慢燃项目                    [菜单]   │
│                                        │
│ 项目名称                                │
│ 简短描述...                             │
│                                        │
│ 📅 2026/02/16 开始                      │
│                                        │
│ ████████░░░░░░░░░░░ 38%              │
│                                        │
│ 🏷️ 标签1 🏷️ 标签2                      │
└────────────────────────────────────────┘
```

**布局说明**:
- 不显示结束时间（与冲刺项目的主要区别）
- 进度条基于 indicators 加权计算
- 开始时间格式为 YYYY/MM/DD

#### 6.5 项目详情页

**慢燃项目详情展示**:
```
┌──────────────────────────────────────────────────────┐
│ 🌱 慢燃项目                              [编辑] [删除] │
├──────────────────────────────────────────────────────┤
│ 进度: ████████████████░░░░░░░ 38%                   │
├──────────────────────────────────────────────────────┤
│ 积累指标                                                 │
│ ┌──────────────────────────────────────────────────┐ │
│ │ 指标名称      当前值/目标值     权重     完成度    │ │
│ │ 阅读页数      150/300           60%      50%      │ │
│ │ ████████████████░░░░░░░░░░░                   │ │
│ │ 笔记数量      10/50             40%      20%     │ │
│ │ ██████░░░░░░░░░░░░░░░░░░░░░                   │ │
│ └──────────────────────────────────────────────────┘ │
├──────────────────────────────────────────────────────┤
│ 开始时间: 2026/02/16                                 │
│ 创建时间: 2026/02/16 14:30  ·  更新时间: 2026/02/18 │
├──────────────────────────────────────────────────────┤
│ 项目描述 (Markdown 渲染区域)                          │
│ ...                                                  │
└──────────────────────────────────────────────────────┘
```

**布局说明**:
- 进度条上方显示总进度百分比
- 每个指标单独显示进度条
- 不显示结束时间

---

### Decision 7: Tiptap vs react-markdown
**Decision**: 使用 Tiptap 全家桶
**Alternatives considered**:
1. **react-markdown + remark plugins**: 轻量，但编辑器体验差，需要自行实现工具栏
2. **Tiptap**: 基于 ProseMirror，插件生态丰富，工具栏易于定制

**Rationale**:
- Tiptap 官方插件覆盖需求（starter-kit, code-block, task-list, table, color, link, image）
- Mermaid 可通过自定义 Tiptap 节点实现
- 更好的编辑体验（所见即所得）
- TypeScript 支持完善

**依赖列表**:
```json
{
  "@tiptap/react": "^2.x",
  "@tiptap/starter-kit": "^2.x",
  "@tiptap/extension-code-block-lowlight": "^2.x",
  "@tiptap/extension-task-list": "^2.x",
  "@tiptap/extension-task-item": "^2.x",
  "@tiptap/extension-table": "^2.x",
  "@tiptap/extension-table-row": "^2.x",
  "@tiptap/extension-table-cell": "^2.x",
  "@tiptap/extension-table-header": "^2.x",
  "@tiptap/extension-color": "^2.x",
  "@tiptap/extension-text-style": "^2.x",
  "@tiptap/extension-link": "^2.x",
  "@tiptap/extension-image": "^2.x",
  "lowlight": "^3.x",
  "mermaid": "^10.x"
}
```

### Decision 8: 时间格式处理
**Decision**: 展示层格式化，存储层保持不变
**Rationale**:
- 数据库存储 ISO 8601 格式，保持精度
- 展示时使用 `date-fns` 格式化为 `YYYY/MM/DD`
- 支持本地化（中文、英文显示不同格式）

**实现方式**:
```typescript
// utils/date.ts
export function formatDate(date: Date | string): string {
  // Chinese: 2026/02/16
  // English: 02/16/2026
  return format(date, locale === 'zh' ? 'yyyy/MM/dd' : 'MM/dd/yyyy');
}
```

## Risks / Trade-offs

| Risk | Mitigation |
|------|------------|
| Breaking change 导致旧数据不兼容 | 提供一次性迁移脚本，变更前备份数据 |
| Tiptap 引入大量依赖 | 仅在需要富文本编辑的地方使用，按需加载 |
| 指标权重计算性能问题 | 指标数量限制为 10 个，计算复杂度 O(n) 可接受 |
| 用户不理解新类型名称 | 添加 tooltip 说明，更新帮助文档 |

## Migration Plan

### Pre-deployment
1. 备份数据库
2. 测试迁移脚本在 staging 环境

### Deployment
1. 执行数据库迁移（更新类型 + 添加 indicators 列）
2. 部署新代码
3. 验证所有 slow-project 已更新为 slow-burn

### Rollback
- 如发现问题，回滚代码到上一版本
- 数据库变更无法回滚（JSONB 列添加不影响现有数据）
- 类型值需要手动回滚（如有必要）

## Open Questions

- [ ] 是否需要为 sprint-project 也添加指标系统？（暂不需要）
- [ ] Tiptap 编辑器是否需要在其他字段使用？（先用于项目描述）
- [ ] 指标历史记录是否后续需求？（记录但不实现 UI）
