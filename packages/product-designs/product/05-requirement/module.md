# 需求管理 - 详细功能

> 本文档汇总了所有与需求管理相关的需求实现细节

---

## 需求管理产品需求文档

- **文档日期**: 20260221
- **文件位置**: packages/product-designs/需求管理-20260221/prd.md
- **主要模块**: 需求管理（本文档为主文档）

### 背景与目标

#### 1.1 背景

当前系统的需求管理模块较为简单，需要升级为完整的需求管理工作流，支持需求列表的层级展示、全生命周期管理、需求与任务的关联、评论与协作、操作记录追溯。

#### 1.2 目标

- 建立统一的需求管理界面，支持表格展示和层级折叠
- 提供右侧滑出式的新增/编辑/查看面板
- 实现需求与任务的双向关联
- 支持评论和附件协作
- 记录完整的需求变更历史

#### 1.3 核心功能

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| 需求列表 | 表格展示 | P0 | 支持父子级层级展示，参考 Element UI Table |
| 需求列表 | 筛选排序 | P0 | 按状态、优先级、负责人筛选；按时间排序 |
| 需求新增 | 右侧滑出面板 | P0 | 从右侧滑出创建表单 |
| 需求编辑 | 右侧滑出面板 | P0 | 与新增共用面板，支持查看模式切换 |
| 需求详情 | 字段展示 | P0 | 展示所有字段及子需求、关联任务 |
| 需求详情 | 评论功能 | P0 | 支持评论和附件 |
| 需求详情 | 操作记录 | P0 | 记录所有变更历史 |
| 子需求 | 层级管理 | P0 | 支持创建子需求，树形展示 |
| 关联任务 | 任务关联 | P0 | 需求可关联多个任务 |

#### 1.4 字段清单

需求字段包含：需求名称、工作项 ID、状态、负责人、开始时间、截止时间、可获得积分、优先级、描述、创建时间、更新时间、子需求、关联任务、评论、操作记录。

#### 1.5 查看详细文档

👉 [查看完整 PRD](../../../需求管理-20260221/prd.md)

👉 [查看国际化文档](../../../需求管理-20260221/i18n.md)

---

## 品牌视觉系统升级 产品需求文档

- **文档日期**: 20260219
- **文件位置**: packages/product-designs/品牌视觉系统升级-20260219/prd.md
- **主要模块**: 设计系统（本文档为关联内容）

### 背景与目标

### 1.1 背景

当前系统存在品牌视觉不统一的问题：
- 侧边栏 Logo（太阳图标）与顶部导航 Logo（黑色方块星星）风格不一致
- 整体设计语言偏向现代但缺乏独特性
- 登录页面的温暖 Glassmorphism 风格未在内部页面延续
- 品牌记忆点不足，无法体现"人人都是产品经理"的产品理念

### 1.2 目标

- 建立统一的品牌视觉识别系统（VI）
- 将登录页面的温暖复古风格延伸至整个产品
- 创造独特的"打字机复古"视觉语言，致敬产品经理文化
- 提升产品专业感和温度感

### 1.3 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| 品牌一致性 | 100% | 所有 Logo 使用统一复古徽章设计 |
| 风格覆盖率 | 100% | 登录页、仪表盘、项目页风格统一 |
| 视觉识别度 | 显著提升 | 用户能一眼识别品牌特征 |

---

### 功能需求

### 3.1 功能列表

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| Logo 统一 | 侧边栏 Logo 替换为复古徽章 | P0 | 统一使用古铜色渐变徽章设计 |
| Logo 统一 | 顶部导航 Logo 替换为复古徽章 | P0 | 统一使用古铜色渐变徽章设计 |
| 色彩系统 | 建立统一的复古配色方案 | P0 | 定义主色、功能色、中性色规范 |
| 字体系统 | 建立复古字体规范 | P1 | 正文、标题、品牌文字字体 |
| 组件规范 | 玻璃态卡片样式统一 | P1 | 统一卡片、按钮、标签样式 |
| 动效规范 | 统一动画时长和缓动函数 | P2 | 定义过渡、悬浮、加载动画 |

### 3.2 功能详细描述

#### 功能 A：Logo 统一替换为复古徽章设计

**描述**：将系统中所有 Logo 统一为复古徽章风格，包含侧边栏和顶部导航。

**设计规格：**

**视觉元素：**
- 尺寸：40x40px（标准）、32x32px（小尺寸适配）
- 形状：圆形徽章
- 渐变：`linear-gradient(135deg, #d4a574, #b8956a, #8b6914, #654321)`
- 边框：深褐色 `#5d4e37`，1px
- 内圈装饰线：米色 `#f5f5dc`，0.5px，60% 透明度

**中心内容：**
- 字母："B"
- 字体：Courier New，14px，bold
- 颜色：深褐色 `#3d2914`
- 字间距：-1px

**装饰元素：**
- 顶部圆点：琥珀金 `#e8b923`，半径 2px，90% 透明度（象征"运行"状态）
- 噪点纹理：SVG 滤镜，30% 透明度

**品牌文字：**
- 主标题："BE.RUN"
  - 字体：Courier New
  - 大小：10px（顶部导航）、12px（侧边栏）
  - 字重：bold
  - 字间距：widest（tracking-widest）
  - 颜色：侧边栏白色、顶部导航 `text-gray-700`
- 副标题："AGILE LIFE"
  - 字体：Courier New
  - 大小：6px（顶部导航）、8px（侧边栏）
  - 字间距：0.15em
  - 颜色：侧边栏 70% 白色、顶部导航 `text-gray-500`
  - 文字转换：大写

**用户流程**：
1. 用户打开登录页 → 看到复古徽章 Logo
2. 用户登录进入系统 → 侧边栏显示复古徽章 Logo
3. 用户浏览项目页 → 顶部导航显示复古徽章 Logo
4. 所有 Logo 视觉风格完全一致

**业务规则**：
- 所有 Logo 使用同一 SVG 组件，支持尺寸缩放
- 颜色根据背景自适应（侧边栏深色背景用白色文字，浅色背景用深色文字）
- 保持可访问性：Logo 包含 aria-label="BE.RUN 品牌 Logo"

---

#### 功能 B：建立统一色彩系统

**描述**：建立包含主色、功能色、中性色的完整配色方案，确保全系统色彩一致性。

**主色调定义：**

| 色彩名称 | Hex 值 | 用途 |
|----------|--------|------|
| 古铜金 | `#d4a574` | Logo 渐变起始 |
| 琥珀橙 | `#fb923c` | 强调色、CTA 按钮 |
| 深橙 | `#ea580c` | 悬停状态 |

**功能色定义：**

| 状态 | 颜色 | 背景 | 边框 |
|------|------|------|------|
| 正常 | emerald-500 | bg-emerald-50 | border-emerald-200 |
| 有风险 | amber-500 | bg-amber-50 | border-amber-200 |
| 失控 | rose-500 | bg-rose-50 | border-rose-200 |
| 高优先级 | rose-600 | bg-rose-50 | border-rose-200 |
| 中优先级 | amber-600 | bg-amber-50 | border-amber-200 |
| 低优先级 | slate-500 | bg-slate-50 | border-slate-200 |

**中性色定义：**

| 色彩名称 | Tailwind 类 | 用途 |
|----------|-------------|------|
| 纯白 | `white` | 卡片背景 |
| 浅灰 | `slate-50` | 页面背景 |
| 中灰 | `slate-400` | 次要文字 |
| 深灰 | `slate-700` | 正文文字 |
| 暗灰 | `slate-800` | 标题文字 |

**业务规则**：
- 所有颜色使用 Tailwind CSS 类，避免硬编码
- 特殊颜色（如古铜金）通过 Tailwind 配置扩展
- 确保所有颜色组合符合 WCAG 2.1 AA 对比度标准

---

#### 功能 C：建立字体规范

**描述**：定义全系统字体使用规范，包含正文、标题、品牌文字。

**字体家族：**

```css
/* 正文字体 */
font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

/* 标题字体 */
font-family: 'Poppins', 'Noto Sans SC', sans-serif;

/* 品牌/复古字体 */
font-family: 'Courier New', Courier, monospace;
```

**字体规格表：**

| 样式 | 字体 | 大小 | 字重 | 行高 | 字间距 |
|------|------|------|------|------|--------|
| H1 | Poppins | 24px | 600 | 1.3 | -0.02em |
| H2 | Poppins | 20px | 600 | 1.3 | -0.02em |
| H3 | Poppins | 16px | 600 | 1.3 | -0.02em |
| Body | Noto Sans SC | 14px | 400 | 1.6 | 0.01em |
| Small | Noto Sans SC | 12px | 400 | 1.5 | 0.005em |
| Label | Noto Sans SC | 10px | 500 | 1.4 | 0.05em |
| Brand | Courier New | 10px | 700 | 1.2 | 0.1em |

**业务规则**：
- 中文字体使用 Noto Sans SC，确保良好的中文显示
- 标题使用 Poppins，增强现代感
- 品牌相关文字使用 Courier New，致敬打字机文化

---

#### 功能 D：玻璃态组件样式统一

**描述**：统一卡片、按钮、标签等组件的玻璃态（Glassmorphism）样式。

**卡片样式：**
```tsx
className="bg-white/80 backdrop-blur-xl rounded-2xl border border-white/60 shadow-xl"
```

**按钮样式：**
- 主按钮：蓝色渐变 + 阴影
- 次要按钮：白色半透明 + 边框

**标签样式：**
- 状态标签：圆点 + 文字
- 优先级标签：图标 + 文字

**业务规则**：
- 所有玻璃态元素使用 `backdrop-blur` 实现毛玻璃效果
- 边框使用半透明白色 `border-white/60`
- 阴影使用柔和的大面积阴影

---

### 验收标准

| 编号 | 验收项 | 验收方式 |
|------|--------|----------|
| AC-01 | 侧边栏显示复古徽章 Logo | 登录后查看侧边栏 |
| AC-02 | 顶部导航显示复古徽章 Logo | 进入项目页查看顶部 |
| AC-03 | 所有 Logo 视觉风格一致 | 对比侧边栏和顶部 Logo |
| AC-04 | Logo 品牌文字显示正确 | 确认 "BE.RUN" 和 "AGILE LIFE" 文字 |
| AC-05 | Logo 颜色在不同背景正常显示 | 侧边栏深色背景、顶部浅色背景 |
| AC-06 | 点击 Logo 可返回首页 | 点击验证跳转 |
| AC-07 | 整体色彩系统统一 | 检查卡片、按钮、标签颜色一致性 |

---

---

## 项目弹窗优化 产品需求文档

- **文档日期**: 20260211
- **文件位置**: packages/product-designs/项目弹窗优化-20260211/prd.md
- **主要模块**: 项目管理（本文档为关联内容）

### 背景与目标

### 1.1 背景

当前项目创建/编辑弹窗（ProjectModal）在用户体验和代码组织方面存在优化空间：ESC 关闭体验不完整、积分计算交互不够直观、组件复用度低、主题色不够灵活。为提升产品易用性和可维护性，需要对弹窗进行全面优化。

### 1.2 目标

- 优化 ESC 关闭弹窗的交互体验，防止误操作导致编辑内容丢失
- 改进积分计算区域的 UI 布局，使其更紧凑直观
- 调整积分基数，让积分价值感更强（1 积分 = 1 元）
- 统一弹窗视觉风格，优化 label/value 的对比度
- 提升组件复用性，建立 UI 组件库
- 支持动态主题色，为后续个性化设置做准备
- 移除编辑态动画，减少视觉干扰
- 简化项目类型为两种：冲刺项目（Sprint）和慢速项目（Slow）

### 1.3 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| ESC 关闭体验 | 编辑时有二次确认 | 测试编辑状态下按 ESC 弹出确认框 |
| 积分计算交互 | 单选框紧邻 label | UI 审查通过 |
| 积分基数 | 10 倍于当前 | 代码审查确认 |
| 组件复用 | 抽离到 UI 库 | 新组件被多处引用 |
| 主题色 | 可配置 | 主题配置对象可修改主色 |

---

### 功能需求

### 3.1 功能列表

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| 弹窗交互 | ESC 关闭 + 二次确认 | P0 | 编辑态下 ESC 触发确认弹窗 |
| 积分设置 | 自动计算单选框优化 | P0 | 单选框紧邻 label，默认选中 |
| 积分计算 | 基数乘以 10 | P0 | 所有积分默认值 ×10 |
| 视觉优化 | label/value 对比度 | P1 | label 颜色比 value 淡 |
| 布局优化 | 创建按钮位置 | P1 | 按钮放在弹窗右下角 |
| 布局优化 | 时间显示格式 | P1 | 仅显示年月日，去掉时分秒 |
| 布局优化 | 编辑模式底部 | P1 | 编辑时移除底部操作栏空白 |
| 组件化 | 抽离 UI 组件库 | P1 | 弹窗内组件可复用 |
| 主题系统 | 动态主题色 | P2 | 主题色可配置，默认与登录页一致 |
| 动画优化 | 移除编辑态动画 | P2 | 删除编辑态到文本态的过渡动画 |
| 项目类型 | 简化为两种类型 | P0 | sprint-project 🏃‍♂️ 和 slow-project 🐢 |

### 3.2 功能详细描述

#### 功能 A：ESC 关闭弹窗 + 二次确认

**描述**：用户按下 ESC 键可关闭弹窗，但当表单处于编辑状态（有未保存的修改）时，显示二次确认对话框，防止误操作丢失数据。

**用户流程**：
1. 用户打开创建/编辑项目弹窗
2. 用户修改任意表单字段（标记为编辑态）
3. 用户按下 ESC 键
4. 系统检测到编辑态，显示确认对话框：「确定放弃添加的内容吗？」
5. 用户选择「确定」→ 关闭弹窗，丢弃修改
6. 用户选择「取消」→ 保持弹窗打开，保留修改

**业务规则**：
- 编辑态判定：任意字段值与初始值不同
- 新建弹窗：初始值为空，输入任意内容即进入编辑态
- 编辑弹窗：初始值为加载的项目数据
- 确认对话框使用系统默认样式或统一 Dialog 组件
- 确认对话框内容统一为：「确定放弃添加的内容吗？」

**异常处理**：
- 无

---

#### 功能 B：积分设置区域优化

**描述**：将「自动计算」勾选框移动到积分 label 右侧，使布局更紧凑。勾选框默认选中，添加 tooltip 提示说明。

**用户流程**：
1. 用户看到积分设置区域
2. 「积分」label 右侧显示勾选框「自动计算」
3. 鼠标悬停勾选框时显示 tooltip：「根据项目优先级自动计算积分值」
4. 默认选中状态下，积分输入框禁用或隐藏
5. 用户取消选中后，积分输入框启用，可手动输入

**业务规则**：
- 勾选框默认选中（true）
- 选中时：积分自动根据项目优先级计算
- 未选中时：积分可手动输入
- UI 布局：label 和勾选框同行，整体更紧凑
- 勾选框文字缩短为「自动计算」，添加 tooltip 提示完整说明

**UI 布局示意**：
```
积分 [自动计算 ☑️] [? tooltip]
[积分输入框 - 自动计算时禁用/隐藏]
```

**表单字段排序**：
| 顺序 | 字段名 | 说明 |
|------|--------|------|
| 1 | 背景图 | 图片上传，限制高度 190px，视觉突出但不遮挡其他内容 |
| 2 | 项目名称 | 必填 |
| 3 | 项目类型 | sprint-project / slow-project |
| 4 | 优先级 | 低/中/高 |
| 5 | 积分 | 与项目状态同行 |
| 6 | 项目状态 | 与积分同行，两列布局 |
| 7 | 开始时间 | 日期选择 |
| 8 | 结束时间 | 日期选择 |
| 9 | 描述 | 文本域 |

**移除字段**：
- 目标（Goals）：已移除
- 标签（Tags）：已移除

**表单美观性优化**：
- 背景图高度调整为 190px，更加突出视觉重点
- 背景图区域使用独立卡片样式，圆角边框，不遮挡其他表单内容
- 减少字段后，增加适当的间距（space-y-6）保持视觉平衡
- 保留进度条和时间戳作为信息补充，不占用主要表单区域

**异常处理**：
- 无

---

#### 功能 C：积分基数调整

**描述**：将所有积分相关的默认计算基数乘以 10，使 1 积分等值于 1 元，提升用户对积分价值的感知。

**用户流程**：
1. 用户创建项目或任务
2. 系统自动计算积分时，使用新基数（原基数 ×10）
3. 用户看到更大的积分值（如原 5 分 → 现 50 分）

**业务规则**：
- 所有积分计算逻辑统一调整
- 优先级对应积分示例：
  - 低优先级：原 10 分 → 现 100 分
  - 中优先级：原 20 分 → 现 200 分
  - 高优先级：原 30 分 → 现 300 分
- 后端存储值同步调整，或保持原值前端显示时 ×10

**异常处理**：
- 历史数据：若后端保持原值，需确认前端显示逻辑一致

---

#### 功能 D：弹窗视觉优化

**描述**：优化弹窗内 label 和 value 的视觉层次，使 label 颜色比 value 更淡，提升可读性。

**用户流程**：
1. 用户打开弹窗
2. 表单 label 使用较淡的颜色（如 text-gray-400）
3. 输入值/选项使用较深的颜色（如 text-gray-900）
4. 整体视觉层次更清晰

**业务规则**：
- Label 颜色：使用低对比度颜色（如 gray-400 或 gray-500）
- Value 颜色：使用高对比度颜色（如 gray-900 或 black）
- 统一应用到所有表单字段

**异常处理**：
- 无

---

#### 功能 E：创建按钮位置调整

**描述**：将弹窗底部的「创建项目」/「保存」按钮放置在弹窗底部右侧，符合主流交互习惯。

**用户流程**：
1. 用户填写完表单
2. 目光自然移动到右下角找到操作按钮
3. 点击按钮提交表单

**业务规则**：
- 按钮位置：弹窗底部右侧
- 按钮对齐：右对齐
- 按钮顺序（若有多个）：主要操作在右，次要操作在左

**异常处理**：
- 无

---

#### 功能 E1：时间显示格式优化

**描述**：将创建时间和更新时间的显示格式从完整的日期时间（年月日时分秒）简化为仅显示年月日，使界面更简洁。

**用户流程**：
1. 用户查看项目详情
2. 时间戳区域显示「创建时间：2026/2/11」格式
3. 不再显示时分秒信息

**业务规则**：
- 显示格式：YYYY/MM/DD（本地化格式）
- 适用于创建时间和更新时间
- 编辑模式和查看模式均适用

**异常处理**：
- 无

---

#### 功能 E2：编辑模式底部布局优化

**描述**：编辑项目时移除底部操作栏的空白区域，使时间戳区域更贴近底部，提升空间利用率。

**用户流程**：
1. 用户编辑已有项目
2. 底部不显示创建按钮（仅新建模式显示）
3. 时间戳区域直接贴近底部，无多余空白

**业务规则**：
- 新建模式：显示底部操作栏和创建按钮
- 编辑模式：隐藏底部操作栏，时间戳下方无额外边距
- 保持视觉整洁

**异常处理**：
- 无

---

#### 功能 F：组件抽离到 UI 库

**描述**：将弹窗内使用的通用组件（如输入框、选择器、单选框、日期选择器等）抽离到 UI 组件库，供其他模块复用。

**用户流程**：
1. 开发者需要用到表单组件
2. 从 UI 库导入对应组件
3. 配置 props 使用

**待抽离组件清单**：
| 组件名 | 用途 | 位置 |
|--------|------|------|
| Modal | 弹窗容器 | components/ui/modal.tsx |
| FormInput | 文本输入框 | components/ui/form-input.tsx |
| FormSelect | 下拉选择器 | components/ui/form-select.tsx |
| FormRadio | 单选框 | components/ui/form-radio.tsx |
| FormDatePicker | 日期选择器 | components/ui/form-date-picker.tsx |
| FormLabel | 表单标签 | components/ui/form-label.tsx |
| ConfirmDialog | 确认对话框 | components/ui/confirm-dialog.tsx |

**业务规则**：
- 组件需支持 TypeScript
- 组件需可配置主题色
- 组件需有完整 props 定义
- 保持现有功能不变

**异常处理**：
- 无

---

#### 功能 G：动态主题色

**描述**：将组件的主题色改为可配置，默认与登录界面提示框颜色（#f97316 / orange-500）保持一致，为后续添加动态主题设置做准备。

**用户流程**：
1. 系统初始化时加载主题配置
2. 组件根据主题配置渲染颜色
3. 后续支持用户自定义主题色

**业务规则**：
- 主题配置对象包含主色、辅色等
- 默认主色与登录界面提示框颜色一致（#f97316 / orange-500）
- 使用 CSS 变量或主题上下文传递配置
- 组件通过主题上下文获取颜色值

**主题配置结构示例**：
```typescript
interface ThemeConfig {
  primary: string;      // 主色
  primaryLight: string; // 主色浅色
  primaryDark: string;  // 主色深色
  // ... 其他颜色
}
```

**异常处理**：
- 无

---

#### 功能 H：移除编辑态动画

**描述**：删除项目详情中编辑态切换到文本态的过渡动画，减少视觉干扰，提升响应速度。

**用户流程**：
1. 用户在项目详情中点击编辑
2. 直接切换到编辑态，无过渡动画
3. 保存或取消后直接切换回文本态，无过渡动画

**业务规则**：
- 移除所有编辑态 ↔ 文本态的 CSS transition/animation
- 保持其他必要的动画（如弹窗出现/消失）

**异常处理**：
- 无

---

#### 功能 I：项目类型简化

**描述**：将项目类型简化为两种：冲刺项目（Sprint Project）⚡ 和长期项目（Long-term Project）🌱，简化用户选择。

**用户流程**：
1. 用户创建项目时选择项目类型
2. 下拉选项显示两种类型及对应表情：
   - ⚡ 冲刺项目（Sprint Project）- 短期、高强度、快速迭代
   - 🌱 长期项目（Long-term Project）- 长期、持续成长、稳步推进
3. 选择后显示对应表情和类型名称

**业务规则**：
- 类型值：`sprint-project` 和 `slow-project`
- 显示格式：表情 + 中文名 + 英文名
- 表情固定：冲刺项目用 ⚡，长期项目用 🌱
- 迁移规则：原 `life` 类型 → `slow-project`，原 `code` 类型 → `sprint-project`

**类型对照表**：
| 新类型 | 表情 | 中文名 | 英文名 | 原类型映射 |
|--------|------|--------|--------|------------|
| sprint-project | ⚡ | 冲刺项目 | Sprint Project | code |
| slow-project | 🌱 | 长期项目 | Long-term Project | life |

**异常处理**：
- 历史数据需迁移，见数据迁移说明

---

### 验收标准

| 编号 | 验收项 | 验收方式 |
|------|--------|----------|
| AC-01 | ESC 关闭弹窗，编辑态下显示二次确认 | 测试编辑状态下按 ESC |
| AC-02 | 积分设置区域紧凑，单选框紧邻 label | UI 审查 |
| AC-03 | 自动计算单选框默认选中 | 代码审查 + 功能测试 |
| AC-04 | 积分基数乘以 10 | 代码审查 |
| AC-05 | Label 颜色比 value 淡 | UI 审查 |
| AC-06 | 创建/保存按钮在右下角 | UI 审查 |
| AC-07 | 组件抽离到 UI 库并可复用 | 代码审查 + 被其他模块引用 |
| AC-08 | 主题色可配置 | 修改主题配置对象，确认颜色变化 |
| AC-09 | 编辑态无过渡动画 | 功能测试 |
| AC-10 | 项目类型为两种，显示正确表情 | 功能测试 |

---

---

## 用户与项目数据持久化 产品需求文档

- **文档日期**: 20260204
- **文件位置**: packages/product-designs/用户与项目数据持久化-20260204/prd.md
- **主要模块**: 用户认证（本文档为关联内容）

### 背景与目标

### 1.1 背景

当前项目在 `openspec/project.md` 中约定「开发/演示应用，使用内存数据库」，用户登录与项目管理均依赖内存/占位数据，导致：

- 用户注册、登录数据无法持久化，重启即丢失
- 项目增删改查仅在内存中生效，无法跨会话保留
- 用户与项目之间无数据关联，无法实现「我的项目」等归属能力

需要将**用户**与**项目**改为真实数据库存储，并与现有技术栈（PostgreSQL）对接，其余模块（任务、需求、缺陷、奖励等）本期仍使用内存数据。

### 1.2 目标

- 删除 project.md 中「使用内存数据库」的整体约定，改为按模块区分：用户与项目使用真实数据库，其余暂用内存
- 用户注册、登录改为真实数据，直接写入/查询数据库
- 项目增删改查改为真实接口，直接读写数据库；**项目数据一律根据当前用户（user）查询与操作，即根据 user 查出来、根据 user 走**
- 项目数据与用户数据建立关联（项目归属用户），所有项目接口以当前登录用户为维度

### 1.3 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| 用户持久化 | 注册/登录数据落库 | 重启服务后仍可登录 |
| 项目持久化 | 项目 CRUD 落库 | 重启后项目列表与编辑结果保留 |
| 用户-项目关联 | 项目根据 user 查、根据 user 走 | 项目列表/详情仅查当前用户；创建/改/删均以当前用户为维度 |

---

### 功能需求

### 3.1 功能列表

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| 项目约定 | 修改 project.md 数据层约定 | P0 | 删除「使用内存数据库」的全局约定，改为用户+项目用真实库、其余用内存 |
| 用户认证 | 用户注册 | P0 | 写入真实数据库（如 PostgreSQL），密码需哈希存储 |
| 用户认证 | 用户登录 | P0 | 从真实数据库校验并建立会话 |
| 项目管理 | 项目 CRUD | P0 | 增删改查走真实接口，数据落库 |
| 数据关联 | 用户-项目关联 | P0 | 项目表含 userId；项目数据根据 user 查、根据 user 走，所有接口以当前用户为维度 |

### 3.2 功能详细描述

#### 功能：修改 project.md 数据层约定

**描述**：在 `openspec/project.md` 中删除「开发/演示应用，使用内存数据库」「数据库在服务器重启时重置」等全局内存数据库约定；在「重要约束」或「数据层」中明确：用户登录数据与项目数据使用真实数据库（如 PostgreSQL），其余模块（任务、需求、缺陷、奖励等）本期仍使用内存数据。

**业务规则**：

- 文档中不再出现「全系统使用内存数据库」的表述
- 外部依赖中已存在 PostgreSQL，需在约定中体现其用于用户与项目

---

#### 功能：用户注册与登录（真实数据）

**描述**：用户注册时写入数据库；登录时从数据库校验昵称与密码（密码需哈希，如 bcrypt），通过后建立会话。不再从 `placeholder-data` 或内存数组读取用户。

**用户流程**：

1. 注册：填写昵称、密码 → 校验格式 → 查重 → 密码哈希 → 写入 DB → 返回成功/失败
2. 登录：填写昵称、密码 → 从 DB 查用户 → 校验密码 → 写 Cookie/Token → 返回用户信息

**业务规则**：

- 密码必须哈希存储（如 bcrypt），不在 DB 中存明文
- 昵称唯一性在 DB 层保证（唯一索引或唯一约束）

**异常处理**：

- 昵称已存在 → 提示「该昵称已被注册」
- 登录失败 → 统一提示「昵称或密码错误」（不暴露具体是昵称还是密码）

---

#### 功能：项目增删改查（真实接口 + 数据库）

**描述**：项目的创建、查询列表、查询详情、更新、删除均通过真实 API 调用后端，后端读写数据库（如 PostgreSQL）。**项目数据根据当前用户（user）查出来、根据 user 走**：所有查询与操作都以当前登录用户为维度，不再使用内存数组或 `placeholder-data`。

**用户流程**：

1. 列表：请求项目列表 API → 后端**根据当前 user** 从 DB 查询该用户的项目 → 返回
2. 详情：请求项目详情 → 后端**根据当前 user** 校验归属后从 DB 查 → 返回
3. 创建：提交表单 → API 写入 DB（必含当前 userId）→ 返回新项目
4. 编辑/删除：后端**根据当前 user** 校验归属后执行，仅允许操作本人的项目

**业务规则**：

- 项目表需包含用户关联字段（如 `userId` 或 `ownerId`）
- **所有项目接口以当前 user 为维度**：查仅查该用户的，改/删仅限该用户的项目；未登录则 401 或空列表

**异常处理**：

- 未登录访问项目接口 → 401 或重定向登录
- 操作非本人项目 → 403 或 404

---

#### 功能：用户与项目数据关联

**描述**：在数据模型与接口上建立用户与项目的关联，**项目数据根据 user 查出来、根据 user 走**：列表/详情只查当前用户的项目，创建/更新/删除都以当前用户为维度。

**业务规则**：

- 项目实体增加「所属用户」字段（如 `userId`），创建时写入当前登录用户 ID
- **根据 user 查**：列表、详情、筛选等查询一律带当前 userId，只返回该用户的项目
- **根据 user 走**：创建归属当前用户；更新/删除时校验归属，仅允许操作本人的项目

---

### 验收标准

| 编号 | 验收项 | 验收方式 |
|------|--------|----------|
| AC-01 | project.md 已删除「使用内存数据库」的全局约定，并写明用户与项目使用真实数据库、其余用内存 | 查阅 project.md |
| AC-02 | 用户注册接口将用户写入数据库，密码为哈希存储 | 查看 DB 记录与代码 |
| AC-03 | 用户登录接口从数据库校验并建立会话，重启服务后仍可登录 | 重启后使用同一账号登录 |
| AC-04 | 项目列表/详情/创建/更新/删除均通过真实接口读写数据库 | 调用 API 并查 DB 验证 |
| AC-05 | 项目根据 user 查、根据 user 走：仅能查看/操作当前用户的项目 | 用不同账号登录验证数据隔离 |

---

---

## 导航架构调整 产品需求文档

- **文档日期**: 20260202
- **文件位置**: packages/product-designs/导航架构调整-20260202/prd.md
- **主要模块**: 项目管理（本文档为关联内容）

### 背景与目标

### 1.1 背景

当前系统导航中，**项目**、**需求**、**任务**、**缺陷**处于同一层级（一级导航），用户需在侧边栏频繁切换才能在不同项目下查看需求、任务或缺陷。这种平铺结构无法体现「需求、任务、缺陷隶属于项目」的业务关系，且项目切换时缺乏上下文感知。

### 1.2 目标

- 重构导航层级：Overview、Project、Rewards、Notifications、Settings 为一级导航；需求、任务、缺陷作为 Project 下的二级导航
- 点击项目后进入项目详情视图，顶部展示项目名、需求/任务/缺陷 Tab、返回项目列表入口
- 提升项目上下文感知，减少导航跳转次数
- 与现有功能（项目 CRUD、需求/任务/缺陷管理）无缝衔接

### 1.3 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| 一级导航项 | 5 个 | 侧边栏仅显示：概览、项目、奖励、通知、设置 |
| 项目详情页二级导航 | 3 个 Tab | 需求、任务、缺陷 |
| 返回项目列表 | 可点击 | 文件夹图标或项目名下拉可返回项目列表 |
| 项目上下文 | 正确传递 | 需求/任务/缺陷列表按当前项目筛选 |

---

### 功能需求

### 3.1 功能列表

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| 一级导航 | 重构侧边栏导航项 | P0 | 仅保留：概览、项目、奖励、通知、设置 |
| 项目列表页 | 保持现有项目卡片列表 | P0 | 点击项目卡片进入项目详情页 |
| 项目详情页 | 顶部栏布局 | P0 | 文件夹图标 + 面包屑 + 项目名 + 下拉 + Tab（需求/任务/缺陷） |
| 项目详情页 | 返回项目列表 | P0 | 点击文件夹图标或下拉选择「返回项目列表」 |
| 项目详情页 | 项目切换 | P0 | 项目名下拉展示项目列表，选择后切换当前项目 |
| 项目详情页 | Tab 内容 | P0 | 需求/任务/缺陷 Tab 展示对应内容，按当前项目筛选 |

### 3.2 功能详细描述

#### 功能 A：一级导航重构

**描述**：将侧边栏（topnav）主导航从当前的「概览、项目、需求、任务、缺陷、奖励」调整为「概览、项目、奖励」，选项菜单保持「通知、设置」。需求、任务、缺陷从一级导航移除。

**用户流程**：
1. 进入 Dashboard
2. 侧边栏仅显示：概览、项目、奖励、通知、设置
3. 点击「项目」进入项目列表页

**业务规则**：
- 一级导航固定为 5 项：概览、项目、奖励、通知、设置
- 习惯、每日、待办等若存在，可并入「概览」或单独保留（本期以概览为主，习惯/每日/待办可暂保留在概览页内）
- 直接访问 `/dashboard/requirement`、`/dashboard/task`、`/dashboard/defect` 时，需重定向到项目列表或默认项目详情页（见路由设计）

**异常处理**：
- 无

---

#### 功能 B：项目列表页

**描述**：保持现有项目卡片列表，点击项目卡片进入项目详情页（含需求/任务/缺陷 Tab）。

**用户流程**：
1. 点击侧边栏「项目」
2. 进入项目列表页，展示所有项目卡片
3. 点击某项目卡片
4. 跳转至项目详情页，URL 形如 `/dashboard/project/[projectId]`，默认选中「需求」Tab

**业务规则**：
- 项目列表页 URL：`/dashboard/project` 或 `/dashboard/project/list`
- 无项目时显示空状态，引导用户新建项目
- 项目卡片点击行为：进入项目详情，而非打开抽屉（抽屉仍可通过卡片「更多」菜单的「编辑」触发）

**异常处理**：
- 项目 ID 无效 → 404 或重定向至项目列表

---

#### 功能 C：项目详情页顶部栏

**描述**：项目详情页顶部展示项目上下文栏，参考视觉稿布局。

**布局结构（自左至右）**：

| 区域 | 元素 | 说明 |
|------|------|------|
| 左侧 | 文件夹图标 | 点击返回项目列表 |
| 左侧 | 右箭头 `>` | 面包屑分隔符 |
| 左侧 | 项目名称 | 当前项目名，可点击展开下拉 |
| 左侧 | 下拉箭头 ∨ | 点击展开项目切换/返回列表菜单 |
| 中部 | 竖线分隔 | 视觉分隔 |
| 右侧 | 需求 Tab | 选中时蓝色文字+下划线 |
| 右侧 | 任务 Tab | 未选中时灰色/黑色文字 |
| 右侧 | 缺陷 Tab | 未选中时灰色/黑色文字 |

**用户流程**：
1. 从项目列表点击项目，进入项目详情页
2. 顶部栏显示：文件夹图标 > 项目名 ∨ | 需求 | 任务 | 缺陷
3. 点击「需求」「任务」「缺陷」切换 Tab，URL 可带 query 如 `?tab=requirement|task|defect`
4. 点击文件夹图标 → 返回项目列表
5. 点击项目名或下拉箭头 → 展开下拉菜单，可切换项目或选择「返回项目列表」

**业务规则**：
- 默认 Tab 为「需求」
- Tab 切换不刷新页面，仅切换内容区域
- 需求/任务/缺陷内容按当前 `projectId` 筛选
- 项目名下拉菜单：列出最近/全部项目，底部有「返回项目列表」选项

**异常处理**：
- 项目被删除 → 返回项目列表并提示

---

#### 功能 D：返回项目列表

**描述**：提供明确的返回项目列表入口。

**用户流程**：
1. 方式一：点击顶部栏左侧文件夹图标
2. 方式二：点击项目名或下拉箭头，在下拉菜单中选择「返回项目列表」
3. 跳转至 `/dashboard/project`（项目列表页）

**业务规则**：
- 两种方式均跳转至项目列表
- 浏览器后退按钮行为：可返回上一页（由路由实现决定）

**异常处理**：
- 无

---

#### 功能 E：项目切换

**描述**：在项目详情页通过项目名下拉菜单切换至另一项目。

**用户流程**：
1. 点击项目名或下拉箭头
2. 展开下拉菜单，展示项目列表（可限制显示数量，如最近 10 个）
3. 点击某项目
4. 切换当前项目，URL 更新为 `/dashboard/project/[newProjectId]`，Tab 保持当前选中（或重置为需求）
5. 内容区域刷新，展示新项目的需求/任务/缺陷

**业务规则**：
- 下拉菜单展示项目列表，按名称或最近使用排序
- 当前项目在列表中高亮或置顶
- 切换后 Tab 状态：建议保持（如当前在任务 Tab，切换项目后仍显示任务 Tab）

**异常处理**：
- 项目列表为空 → 仅显示「返回项目列表」

---

#### 功能 F：需求/任务/缺陷 Tab 内容

**描述**：三个 Tab 分别展示当前项目下的需求、任务、缺陷，复用现有需求页、任务页、缺陷页的组件与逻辑，增加 `projectId` 筛选。

**用户流程**：
1. 进入项目详情页，默认显示「需求」Tab
2. 需求 Tab：展示该项目的需求列表/看板
3. 任务 Tab：展示该项目的任务列表
4. 缺陷 Tab：展示该项目的缺陷列表（code 类型项目才显示，life 类型可隐藏或显示空状态）

**业务规则**：
- 需求 API：`GET /api/requirements?projectId=xxx`
- 任务 API：需支持按 projectId 筛选（若现有 API 无此参数，需扩展）
- 缺陷 API：需支持按 projectId 筛选（若现有 API 无此参数，需扩展）
- 缺陷 Tab：code 类型项目显示，life 类型可隐藏或提示「仅代码项目有缺陷」
- 各 Tab 内容区域复用现有 RequirementKanban、TaskCard、Defect 等组件

**异常处理**：
- 项目无需求/任务/缺陷 → 显示空状态
- API 失败 → 显示错误提示

---

### 验收标准

| 编号 | 验收项 | 验收方式 |
|------|--------|----------|
| AC-01 | 一级导航仅含概览、项目、奖励、通知、设置 | 侧边栏不显示需求、任务、缺陷 |
| AC-02 | 点击项目卡片进入项目详情页 | 跳转至 /dashboard/project/[id]，顶部显示项目名 |
| AC-03 | 项目详情页顶部栏包含文件夹图标、项目名、需求/任务/缺陷 Tab | 布局与视觉参考一致 |
| AC-04 | 点击文件夹图标返回项目列表 | 跳转至 /dashboard/project |
| AC-05 | 项目名下拉可切换项目、选择返回项目列表 | 下拉菜单功能正常 |
| AC-06 | 需求/任务/缺陷 Tab 切换正确展示对应内容 | 内容按当前项目筛选 |
| AC-07 | 直接访问 /dashboard/requirement 等旧路径 | 重定向至项目列表或默认项目详情 |
| AC-08 | 项目详情页编辑入口 | 通过内容区或顶部栏可打开项目编辑（抽屉/弹窗） |

---

---

## 项目管理增强 产品需求文档

- **文档日期**: 20260201
- **文件位置**: packages/product-designs/项目管理增强-20260201/prd.md
- **主要模块**: 项目管理（本文档为关联内容）

### 背景与目标

### 1.1 背景

当前项目管理模块面向个人用户的项目广场，已具备项目 CRUD、状态筛选、抽屉式详情编辑等基础能力。用户反馈希望功能更加清晰明了，包括：项目描述支持富文本编辑、状态语义更贴近实际、时间字段命名更准确、详情界面减少干扰性操作入口。

### 1.2 目标

- 提升项目描述的编辑体验，支持 Markdown 格式
- 简化项目状态语义，使「正常 / 有风险 / 失控」更直观
- 统一时间字段命名（开始时间、截止时间），减少歧义
- 优化项目详情界面，移除冗余提示与过于显眼的删除入口

### 1.3 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| 描述编辑体验 | 支持 MD 语法 | 可输入并渲染 Markdown |
| 状态选项 | 3 个 | 下拉仅显示：正常、有风险、失控 |
| 界面简洁度 | 无冗余提示 | 详情底部无「修改后自动保存」、无删除按钮 |

---

### 功能需求

### 3.1 功能列表

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| 项目描述 | 引入 Tiptap MD 编辑器 | P0 | 替换现有 textarea，支持 Markdown |
| 项目状态 | 状态选项调整为三值 | P0 | 正常、有风险、失控 |
| 时间字段 | 标签与语义调整 | P0 | 开始日期→开始时间，结束日期→截止时间 |
| 项目详情 | 移除删除入口与自动保存提示 | P0 | 详情抽屉底部移除删除按钮和「修改后自动保存」 |

### 3.2 功能详细描述

#### 功能 A：项目描述引入 Tiptap MD 编辑器

**描述**：将项目描述字段从普通 textarea 替换为基于 Tiptap 的 Markdown 编辑器，支持标题、列表、粗体、链接等常用格式。

**用户流程**：
1. 打开项目详情抽屉
2. 在描述区域点击进入编辑
3. 使用工具栏或 Markdown 语法输入内容
4. 失焦或切换字段时自动保存（沿用现有自动保存逻辑）

**业务规则**：
- 存储格式为 Markdown 字符串，与现有 `description` 字段兼容
- 新建项目时描述可为空
- 编辑模式下支持所见即所得或源码模式（由 Tiptap 扩展决定）

**异常处理**：
- 网络保存失败 → 显示错误提示，保留本地输入
- 超长内容 → 按后端限制校验（如有）

---

#### 功能 B：项目状态下拉值调整为三值

**描述**：将项目状态从当前的 planning / active / paused / completed 调整为：正常、有风险、失控。

**用户流程**：
1. 在项目详情或新建表单中打开状态下拉
2. 选择「正常」「有风险」「失控」之一
3. 选择后自动保存（编辑模式）或随表单提交（新建模式）

**业务规则**：
- 状态为必填
- 三值对应：`normal`（正常）、`at_risk`（有风险）、`out_of_control`（失控）
- 项目列表页筛选需同步调整（若当前按状态筛选，需映射新值）
- 历史数据迁移：需定义 planning/active/paused/completed 到新三值的映射规则

**异常处理**：
- 无

---

#### 功能 C：开始日期→开始时间，结束日期→截止时间

**描述**：将时间相关字段的 UI 标签与语义调整：开始日期改为开始时间，结束日期改为截止时间。可选支持日期时间选择器以提升精度。

**用户流程**：
1. 在项目详情或新建表单中看到「开始时间」「截止时间」标签
2. 通过日期或日期时间选择器填写
3. 保存后正确展示

**业务规则**：
- 开始时间：必填，不能晚于截止时间（若截止时间已填）
- 截止时间：可选，不能早于开始时间
- 存储格式保持 ISO 8601 字符串，与现有 API 兼容
- 后端字段名可保持 `startDate`、`endDate`，仅前端展示与校验逻辑调整

**异常处理**：
- 截止时间早于开始时间 → 校验不通过，提示「截止时间不能早于开始时间」

---

#### 功能 D：项目详情界面精简

**描述**：在项目详情抽屉（ProjectDrawer 编辑模式）中，移除删除项目入口和「修改后自动保存」提示。

**用户流程**：
1. 点击项目卡片打开详情抽屉
2. 底部操作栏不再显示删除按钮
3. 底部不再显示「修改后自动保存」文字

**业务规则**：
- 删除功能仍可通过项目卡片上的「更多」菜单（三点菜单）触发，仅从详情抽屉内移除
- 自动保存逻辑不变，仅移除提示文案

**异常处理**：
- 无

---

### 验收标准

| 编号 | 验收项 | 验收方式 |
|------|--------|----------|
| AC-01 | 项目描述使用 Tiptap MD 编辑器 | 打开详情，描述区域可输入并渲染 Markdown |
| AC-02 | 状态下拉仅显示正常、有风险、失控 | 新建/编辑时状态选项为上述三值 |
| AC-03 | 时间字段标签为「开始时间」「截止时间」 | 表单与详情中标签正确显示 |
| AC-04 | 详情抽屉底部无删除按钮 | 编辑模式下底部不显示删除 |
| AC-05 | 详情抽屉底部无「修改后自动保存」 | 编辑模式下底部无该提示 |
| AC-06 | 修改后仍可自动保存 | 编辑任意字段后，SaveStatusIndicator 正常反馈保存状态 |

---

---

