# 缺陷管理 - 详细功能

> 本文档汇总了所有与缺陷管理相关的需求实现细节

## 用户与项目数据持久化 产品需求文档

- **文档日期**: 20260204
- **文件位置**: packages/product-designs/用户与项目数据持久化-20260204/prd.md
- **主要模块**: 用户认证（本文档为关联内容）

### 背景与目标

### 1.1 背景

当前项目在 `openspec/project.md` 中约定「开发/演示应用，使用内存数据库」，用户登录与项目管理均依赖内存/占位数据，导致：

- 用户注册、登录数据无法持久化，重启即丢失
- 项目增删改查仅在内存中生效，无法跨会话保留
- 用户与项目之间无数据关联，无法实现「我的项目」等归属能力

需要将**用户**与**项目**改为真实数据库存储，并与现有技术栈（PostgreSQL）对接，其余模块（任务、需求、缺陷、奖励等）本期仍使用内存数据。

### 1.2 目标

- 删除 project.md 中「使用内存数据库」的整体约定，改为按模块区分：用户与项目使用真实数据库，其余暂用内存
- 用户注册、登录改为真实数据，直接写入/查询数据库
- 项目增删改查改为真实接口，直接读写数据库；**项目数据一律根据当前用户（user）查询与操作，即根据 user 查出来、根据 user 走**
- 项目数据与用户数据建立关联（项目归属用户），所有项目接口以当前登录用户为维度

### 1.3 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| 用户持久化 | 注册/登录数据落库 | 重启服务后仍可登录 |
| 项目持久化 | 项目 CRUD 落库 | 重启后项目列表与编辑结果保留 |
| 用户-项目关联 | 项目根据 user 查、根据 user 走 | 项目列表/详情仅查当前用户；创建/改/删均以当前用户为维度 |

---

### 功能需求

### 3.1 功能列表

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| 项目约定 | 修改 project.md 数据层约定 | P0 | 删除「使用内存数据库」的全局约定，改为用户+项目用真实库、其余用内存 |
| 用户认证 | 用户注册 | P0 | 写入真实数据库（如 PostgreSQL），密码需哈希存储 |
| 用户认证 | 用户登录 | P0 | 从真实数据库校验并建立会话 |
| 项目管理 | 项目 CRUD | P0 | 增删改查走真实接口，数据落库 |
| 数据关联 | 用户-项目关联 | P0 | 项目表含 userId；项目数据根据 user 查、根据 user 走，所有接口以当前用户为维度 |

### 3.2 功能详细描述

#### 功能：修改 project.md 数据层约定

**描述**：在 `openspec/project.md` 中删除「开发/演示应用，使用内存数据库」「数据库在服务器重启时重置」等全局内存数据库约定；在「重要约束」或「数据层」中明确：用户登录数据与项目数据使用真实数据库（如 PostgreSQL），其余模块（任务、需求、缺陷、奖励等）本期仍使用内存数据。

**业务规则**：

- 文档中不再出现「全系统使用内存数据库」的表述
- 外部依赖中已存在 PostgreSQL，需在约定中体现其用于用户与项目

---

#### 功能：用户注册与登录（真实数据）

**描述**：用户注册时写入数据库；登录时从数据库校验昵称与密码（密码需哈希，如 bcrypt），通过后建立会话。不再从 `placeholder-data` 或内存数组读取用户。

**用户流程**：

1. 注册：填写昵称、密码 → 校验格式 → 查重 → 密码哈希 → 写入 DB → 返回成功/失败
2. 登录：填写昵称、密码 → 从 DB 查用户 → 校验密码 → 写 Cookie/Token → 返回用户信息

**业务规则**：

- 密码必须哈希存储（如 bcrypt），不在 DB 中存明文
- 昵称唯一性在 DB 层保证（唯一索引或唯一约束）

**异常处理**：

- 昵称已存在 → 提示「该昵称已被注册」
- 登录失败 → 统一提示「昵称或密码错误」（不暴露具体是昵称还是密码）

---

#### 功能：项目增删改查（真实接口 + 数据库）

**描述**：项目的创建、查询列表、查询详情、更新、删除均通过真实 API 调用后端，后端读写数据库（如 PostgreSQL）。**项目数据根据当前用户（user）查出来、根据 user 走**：所有查询与操作都以当前登录用户为维度，不再使用内存数组或 `placeholder-data`。

**用户流程**：

1. 列表：请求项目列表 API → 后端**根据当前 user** 从 DB 查询该用户的项目 → 返回
2. 详情：请求项目详情 → 后端**根据当前 user** 校验归属后从 DB 查 → 返回
3. 创建：提交表单 → API 写入 DB（必含当前 userId）→ 返回新项目
4. 编辑/删除：后端**根据当前 user** 校验归属后执行，仅允许操作本人的项目

**业务规则**：

- 项目表需包含用户关联字段（如 `userId` 或 `ownerId`）
- **所有项目接口以当前 user 为维度**：查仅查该用户的，改/删仅限该用户的项目；未登录则 401 或空列表

**异常处理**：

- 未登录访问项目接口 → 401 或重定向登录
- 操作非本人项目 → 403 或 404

---

#### 功能：用户与项目数据关联

**描述**：在数据模型与接口上建立用户与项目的关联，**项目数据根据 user 查出来、根据 user 走**：列表/详情只查当前用户的项目，创建/更新/删除都以当前用户为维度。

**业务规则**：

- 项目实体增加「所属用户」字段（如 `userId`），创建时写入当前登录用户 ID
- **根据 user 查**：列表、详情、筛选等查询一律带当前 userId，只返回该用户的项目
- **根据 user 走**：创建归属当前用户；更新/删除时校验归属，仅允许操作本人的项目

---

### 验收标准

| 编号 | 验收项 | 验收方式 |
|------|--------|----------|
| AC-01 | project.md 已删除「使用内存数据库」的全局约定，并写明用户与项目使用真实数据库、其余用内存 | 查阅 project.md |
| AC-02 | 用户注册接口将用户写入数据库，密码为哈希存储 | 查看 DB 记录与代码 |
| AC-03 | 用户登录接口从数据库校验并建立会话，重启服务后仍可登录 | 重启后使用同一账号登录 |
| AC-04 | 项目列表/详情/创建/更新/删除均通过真实接口读写数据库 | 调用 API 并查 DB 验证 |
| AC-05 | 项目根据 user 查、根据 user 走：仅能查看/操作当前用户的项目 | 用不同账号登录验证数据隔离 |

---

---

## 导航架构调整 产品需求文档

- **文档日期**: 20260202
- **文件位置**: packages/product-designs/导航架构调整-20260202/prd.md
- **主要模块**: 项目管理（本文档为关联内容）

### 背景与目标

### 1.1 背景

当前系统导航中，**项目**、**需求**、**任务**、**缺陷**处于同一层级（一级导航），用户需在侧边栏频繁切换才能在不同项目下查看需求、任务或缺陷。这种平铺结构无法体现「需求、任务、缺陷隶属于项目」的业务关系，且项目切换时缺乏上下文感知。

### 1.2 目标

- 重构导航层级：Overview、Project、Rewards、Notifications、Settings 为一级导航；需求、任务、缺陷作为 Project 下的二级导航
- 点击项目后进入项目详情视图，顶部展示项目名、需求/任务/缺陷 Tab、返回项目列表入口
- 提升项目上下文感知，减少导航跳转次数
- 与现有功能（项目 CRUD、需求/任务/缺陷管理）无缝衔接

### 1.3 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| 一级导航项 | 5 个 | 侧边栏仅显示：概览、项目、奖励、通知、设置 |
| 项目详情页二级导航 | 3 个 Tab | 需求、任务、缺陷 |
| 返回项目列表 | 可点击 | 文件夹图标或项目名下拉可返回项目列表 |
| 项目上下文 | 正确传递 | 需求/任务/缺陷列表按当前项目筛选 |

---

### 功能需求

### 3.1 功能列表

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| 一级导航 | 重构侧边栏导航项 | P0 | 仅保留：概览、项目、奖励、通知、设置 |
| 项目列表页 | 保持现有项目卡片列表 | P0 | 点击项目卡片进入项目详情页 |
| 项目详情页 | 顶部栏布局 | P0 | 文件夹图标 + 面包屑 + 项目名 + 下拉 + Tab（需求/任务/缺陷） |
| 项目详情页 | 返回项目列表 | P0 | 点击文件夹图标或下拉选择「返回项目列表」 |
| 项目详情页 | 项目切换 | P0 | 项目名下拉展示项目列表，选择后切换当前项目 |
| 项目详情页 | Tab 内容 | P0 | 需求/任务/缺陷 Tab 展示对应内容，按当前项目筛选 |

### 3.2 功能详细描述

#### 功能 A：一级导航重构

**描述**：将侧边栏（topnav）主导航从当前的「概览、项目、需求、任务、缺陷、奖励」调整为「概览、项目、奖励」，选项菜单保持「通知、设置」。需求、任务、缺陷从一级导航移除。

**用户流程**：
1. 进入 Dashboard
2. 侧边栏仅显示：概览、项目、奖励、通知、设置
3. 点击「项目」进入项目列表页

**业务规则**：
- 一级导航固定为 5 项：概览、项目、奖励、通知、设置
- 习惯、每日、待办等若存在，可并入「概览」或单独保留（本期以概览为主，习惯/每日/待办可暂保留在概览页内）
- 直接访问 `/dashboard/requirement`、`/dashboard/task`、`/dashboard/defect` 时，需重定向到项目列表或默认项目详情页（见路由设计）

**异常处理**：
- 无

---

#### 功能 B：项目列表页

**描述**：保持现有项目卡片列表，点击项目卡片进入项目详情页（含需求/任务/缺陷 Tab）。

**用户流程**：
1. 点击侧边栏「项目」
2. 进入项目列表页，展示所有项目卡片
3. 点击某项目卡片
4. 跳转至项目详情页，URL 形如 `/dashboard/project/[projectId]`，默认选中「需求」Tab

**业务规则**：
- 项目列表页 URL：`/dashboard/project` 或 `/dashboard/project/list`
- 无项目时显示空状态，引导用户新建项目
- 项目卡片点击行为：进入项目详情，而非打开抽屉（抽屉仍可通过卡片「更多」菜单的「编辑」触发）

**异常处理**：
- 项目 ID 无效 → 404 或重定向至项目列表

---

#### 功能 C：项目详情页顶部栏

**描述**：项目详情页顶部展示项目上下文栏，参考视觉稿布局。

**布局结构（自左至右）**：

| 区域 | 元素 | 说明 |
|------|------|------|
| 左侧 | 文件夹图标 | 点击返回项目列表 |
| 左侧 | 右箭头 `>` | 面包屑分隔符 |
| 左侧 | 项目名称 | 当前项目名，可点击展开下拉 |
| 左侧 | 下拉箭头 ∨ | 点击展开项目切换/返回列表菜单 |
| 中部 | 竖线分隔 | 视觉分隔 |
| 右侧 | 需求 Tab | 选中时蓝色文字+下划线 |
| 右侧 | 任务 Tab | 未选中时灰色/黑色文字 |
| 右侧 | 缺陷 Tab | 未选中时灰色/黑色文字 |

**用户流程**：
1. 从项目列表点击项目，进入项目详情页
2. 顶部栏显示：文件夹图标 > 项目名 ∨ | 需求 | 任务 | 缺陷
3. 点击「需求」「任务」「缺陷」切换 Tab，URL 可带 query 如 `?tab=requirement|task|defect`
4. 点击文件夹图标 → 返回项目列表
5. 点击项目名或下拉箭头 → 展开下拉菜单，可切换项目或选择「返回项目列表」

**业务规则**：
- 默认 Tab 为「需求」
- Tab 切换不刷新页面，仅切换内容区域
- 需求/任务/缺陷内容按当前 `projectId` 筛选
- 项目名下拉菜单：列出最近/全部项目，底部有「返回项目列表」选项

**异常处理**：
- 项目被删除 → 返回项目列表并提示

---

#### 功能 D：返回项目列表

**描述**：提供明确的返回项目列表入口。

**用户流程**：
1. 方式一：点击顶部栏左侧文件夹图标
2. 方式二：点击项目名或下拉箭头，在下拉菜单中选择「返回项目列表」
3. 跳转至 `/dashboard/project`（项目列表页）

**业务规则**：
- 两种方式均跳转至项目列表
- 浏览器后退按钮行为：可返回上一页（由路由实现决定）

**异常处理**：
- 无

---

#### 功能 E：项目切换

**描述**：在项目详情页通过项目名下拉菜单切换至另一项目。

**用户流程**：
1. 点击项目名或下拉箭头
2. 展开下拉菜单，展示项目列表（可限制显示数量，如最近 10 个）
3. 点击某项目
4. 切换当前项目，URL 更新为 `/dashboard/project/[newProjectId]`，Tab 保持当前选中（或重置为需求）
5. 内容区域刷新，展示新项目的需求/任务/缺陷

**业务规则**：
- 下拉菜单展示项目列表，按名称或最近使用排序
- 当前项目在列表中高亮或置顶
- 切换后 Tab 状态：建议保持（如当前在任务 Tab，切换项目后仍显示任务 Tab）

**异常处理**：
- 项目列表为空 → 仅显示「返回项目列表」

---

#### 功能 F：需求/任务/缺陷 Tab 内容

**描述**：三个 Tab 分别展示当前项目下的需求、任务、缺陷，复用现有需求页、任务页、缺陷页的组件与逻辑，增加 `projectId` 筛选。

**用户流程**：
1. 进入项目详情页，默认显示「需求」Tab
2. 需求 Tab：展示该项目的需求列表/看板
3. 任务 Tab：展示该项目的任务列表
4. 缺陷 Tab：展示该项目的缺陷列表（code 类型项目才显示，life 类型可隐藏或显示空状态）

**业务规则**：
- 需求 API：`GET /api/requirements?projectId=xxx`
- 任务 API：需支持按 projectId 筛选（若现有 API 无此参数，需扩展）
- 缺陷 API：需支持按 projectId 筛选（若现有 API 无此参数，需扩展）
- 缺陷 Tab：code 类型项目显示，life 类型可隐藏或提示「仅代码项目有缺陷」
- 各 Tab 内容区域复用现有 RequirementKanban、TaskCard、Defect 等组件

**异常处理**：
- 项目无需求/任务/缺陷 → 显示空状态
- API 失败 → 显示错误提示

---

### 验收标准

| 编号 | 验收项 | 验收方式 |
|------|--------|----------|
| AC-01 | 一级导航仅含概览、项目、奖励、通知、设置 | 侧边栏不显示需求、任务、缺陷 |
| AC-02 | 点击项目卡片进入项目详情页 | 跳转至 /dashboard/project/[id]，顶部显示项目名 |
| AC-03 | 项目详情页顶部栏包含文件夹图标、项目名、需求/任务/缺陷 Tab | 布局与视觉参考一致 |
| AC-04 | 点击文件夹图标返回项目列表 | 跳转至 /dashboard/project |
| AC-05 | 项目名下拉可切换项目、选择返回项目列表 | 下拉菜单功能正常 |
| AC-06 | 需求/任务/缺陷 Tab 切换正确展示对应内容 | 内容按当前项目筛选 |
| AC-07 | 直接访问 /dashboard/requirement 等旧路径 | 重定向至项目列表或默认项目详情 |
| AC-08 | 项目详情页编辑入口 | 通过内容区或顶部栏可打开项目编辑（抽屉/弹窗） |

---

---

