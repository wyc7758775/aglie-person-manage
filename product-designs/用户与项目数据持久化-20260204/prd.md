# 用户与项目数据持久化 产品需求文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 作者 | |
| 创建日期 | 2026-02-04 |
| 更新日期 | 2026-02-04 |
| 状态 | 草稿 |

---

## 1. 背景与目标

### 1.1 背景

当前项目在 `openspec/project.md` 中约定「开发/演示应用，使用内存数据库」，用户登录与项目管理均依赖内存/占位数据，导致：

- 用户注册、登录数据无法持久化，重启即丢失
- 项目增删改查仅在内存中生效，无法跨会话保留
- 用户与项目之间无数据关联，无法实现「我的项目」等归属能力

需要将**用户**与**项目**改为真实数据库存储，并与现有技术栈（PostgreSQL）对接，其余模块（任务、需求、缺陷、奖励等）本期仍使用内存数据。

### 1.2 目标

- 删除 project.md 中「使用内存数据库」的整体约定，改为按模块区分：用户与项目使用真实数据库，其余暂用内存
- 用户注册、登录改为真实数据，直接写入/查询数据库
- 项目增删改查改为真实接口，直接读写数据库；**项目数据一律根据当前用户（user）查询与操作，即根据 user 查出来、根据 user 走**
- 项目数据与用户数据建立关联（项目归属用户），所有项目接口以当前登录用户为维度

### 1.3 成功指标

| 指标 | 目标值 | 衡量方式 |
|------|--------|----------|
| 用户持久化 | 注册/登录数据落库 | 重启服务后仍可登录 |
| 项目持久化 | 项目 CRUD 落库 | 重启后项目列表与编辑结果保留 |
| 用户-项目关联 | 项目根据 user 查、根据 user 走 | 项目列表/详情仅查当前用户；创建/改/删均以当前用户为维度 |

---

## 2. 用户与场景

### 2.1 目标用户

| 用户类型 | 描述 | 核心诉求 |
|----------|------|----------|
| 个人用户 | 使用系统的终端用户 | 账号与项目数据持久化、不因重启丢失 |

### 2.2 使用场景

| 场景 | 描述 | 频率 |
|------|------|------|
| 注册与登录 | 用户注册账号、登录后使用系统 | 每次使用 |
| 项目管理 | 创建、查看、编辑、删除项目，且数据长期保留 | 日常 |

### 2.3 用户故事

- **作为** 个人用户，**我希望** 注册与登录使用真实数据库存储，**以便** 重启服务后仍能登录同一账号
- **作为** 个人用户，**我希望** 项目的增删改查都写入数据库并与我的账号关联，**以便** 项目数据持久化且仅我能管理自己的项目

---

## 3. 功能需求

### 3.1 功能列表

| 功能模块 | 功能点 | 优先级 | 说明 |
|----------|--------|--------|------|
| 项目约定 | 修改 project.md 数据层约定 | P0 | 删除「使用内存数据库」的全局约定，改为用户+项目用真实库、其余用内存 |
| 用户认证 | 用户注册 | P0 | 写入真实数据库（如 PostgreSQL），密码需哈希存储 |
| 用户认证 | 用户登录 | P0 | 从真实数据库校验并建立会话 |
| 项目管理 | 项目 CRUD | P0 | 增删改查走真实接口，数据落库 |
| 数据关联 | 用户-项目关联 | P0 | 项目表含 userId；项目数据根据 user 查、根据 user 走，所有接口以当前用户为维度 |

### 3.2 功能详细描述

#### 功能：修改 project.md 数据层约定

**描述**：在 `openspec/project.md` 中删除「开发/演示应用，使用内存数据库」「数据库在服务器重启时重置」等全局内存数据库约定；在「重要约束」或「数据层」中明确：用户登录数据与项目数据使用真实数据库（如 PostgreSQL），其余模块（任务、需求、缺陷、奖励等）本期仍使用内存数据。

**业务规则**：

- 文档中不再出现「全系统使用内存数据库」的表述
- 外部依赖中已存在 PostgreSQL，需在约定中体现其用于用户与项目

---

#### 功能：用户注册与登录（真实数据）

**描述**：用户注册时写入数据库；登录时从数据库校验昵称与密码（密码需哈希，如 bcrypt），通过后建立会话。不再从 `placeholder-data` 或内存数组读取用户。

**用户流程**：

1. 注册：填写昵称、密码 → 校验格式 → 查重 → 密码哈希 → 写入 DB → 返回成功/失败
2. 登录：填写昵称、密码 → 从 DB 查用户 → 校验密码 → 写 Cookie/Token → 返回用户信息

**业务规则**：

- 密码必须哈希存储（如 bcrypt），不在 DB 中存明文
- 昵称唯一性在 DB 层保证（唯一索引或唯一约束）

**异常处理**：

- 昵称已存在 → 提示「该昵称已被注册」
- 登录失败 → 统一提示「昵称或密码错误」（不暴露具体是昵称还是密码）

---

#### 功能：项目增删改查（真实接口 + 数据库）

**描述**：项目的创建、查询列表、查询详情、更新、删除均通过真实 API 调用后端，后端读写数据库（如 PostgreSQL）。**项目数据根据当前用户（user）查出来、根据 user 走**：所有查询与操作都以当前登录用户为维度，不再使用内存数组或 `placeholder-data`。

**用户流程**：

1. 列表：请求项目列表 API → 后端**根据当前 user** 从 DB 查询该用户的项目 → 返回
2. 详情：请求项目详情 → 后端**根据当前 user** 校验归属后从 DB 查 → 返回
3. 创建：提交表单 → API 写入 DB（必含当前 userId）→ 返回新项目
4. 编辑/删除：后端**根据当前 user** 校验归属后执行，仅允许操作本人的项目

**业务规则**：

- 项目表需包含用户关联字段（如 `userId` 或 `ownerId`）
- **所有项目接口以当前 user 为维度**：查仅查该用户的，改/删仅限该用户的项目；未登录则 401 或空列表

**异常处理**：

- 未登录访问项目接口 → 401 或重定向登录
- 操作非本人项目 → 403 或 404

---

#### 功能：用户与项目数据关联

**描述**：在数据模型与接口上建立用户与项目的关联，**项目数据根据 user 查出来、根据 user 走**：列表/详情只查当前用户的项目，创建/更新/删除都以当前用户为维度。

**业务规则**：

- 项目实体增加「所属用户」字段（如 `userId`），创建时写入当前登录用户 ID
- **根据 user 查**：列表、详情、筛选等查询一律带当前 userId，只返回该用户的项目
- **根据 user 走**：创建归属当前用户；更新/删除时校验归属，仅允许操作本人的项目

---

## 4. 交互逻辑（前端）

本期主要为后端与数据层改造，前端在「调用真实注册/登录/项目 API、按登录状态与返回数据展示」上需与后端对齐，无新增独立交互稿时，可沿用现有登录页与项目列表/表单的交互，仅将请求从内存/占位改为真实接口。

### 4.1 原型链接

| 项目 | 内容 |
|------|------|
| 墨刀原型 | 本期无新增页面，沿用现有登录与项目相关页面 |

### 4.2 交互逻辑表（与真实接口对接）

| 页面/组件 | 交互点 | 触发 | 前置条件 | 行为 | 结果/状态 | 异常/边界 |
|-----------|--------|------|----------|------|-----------|-----------|
| 登录/注册 | 提交 | 点击登录/注册 | 表单已填 | 调用真实 API | 成功：跳转/写 Cookie；失败：展示 API 返回信息 | 网络错误、重复昵称等提示 |
| 项目列表 | 加载/刷新 | 进入页或刷新 | 已登录 | 调用项目列表 API（按用户） | 展示当前用户项目列表 | 未登录：跳转登录；空列表正常展示 |
| 项目表单 | 提交创建/更新 | 点击保存 | 已登录、表单合法 | 调用项目创建/更新 API | 成功：关闭抽屉/刷新列表；失败：展示错误信息 | 403/404 提示无权限或不存在 |

---

## 5. 非功能需求

| 类型 | 要求 |
|------|------|
| 安全 | 用户密码必须哈希存储（如 bcrypt）；生产环境禁止明文密码 |
| 兼容性 | 与现有 Next.js、App Router、API 路由风格一致；保留现有类型定义（可扩展 userId 等字段） |
| 可用性 | 用户与项目相关接口需明确错误码与错误信息，便于前端统一提示 |

---

## 6. 验收标准

| 编号 | 验收项 | 验收方式 |
|------|--------|----------|
| AC-01 | project.md 已删除「使用内存数据库」的全局约定，并写明用户与项目使用真实数据库、其余用内存 | 查阅 project.md |
| AC-02 | 用户注册接口将用户写入数据库，密码为哈希存储 | 查看 DB 记录与代码 |
| AC-03 | 用户登录接口从数据库校验并建立会话，重启服务后仍可登录 | 重启后使用同一账号登录 |
| AC-04 | 项目列表/详情/创建/更新/删除均通过真实接口读写数据库 | 调用 API 并查 DB 验证 |
| AC-05 | 项目根据 user 查、根据 user 走：仅能查看/操作当前用户的项目 | 用不同账号登录验证数据隔离 |

---

## 7. 范围与排期

### 7.1 本期范围（In Scope）

- 修改 `openspec/project.md` 中数据层与重要约束（删除内存库全局约定，明确用户+项目用真实库）
- 用户注册、登录改为真实数据库读写，密码哈希
- 项目增删改查改为真实接口与数据库，项目表与用户关联
- 其余模块（任务、需求、缺陷、奖励等）仍使用内存数据，不做本期改造

### 7.2 下期范围（Out of Scope）

- 任务、需求、缺陷、奖励等模块的持久化（仍保留内存）
- 自动化测试、性能压测等

### 7.3 里程碑

| 阶段 | 交付物 | 预计时间 |
|------|--------|----------|
| 约定与设计 | project.md 更新、数据表/接口设计 | 本期 |
| 用户持久化 | 注册/登录落库、密码哈希 | 本期 |
| 项目持久化 | 项目 CRUD 真实接口、用户关联 | 本期 |

---

## 8. 附录

### 8.1 术语表

| 术语 | 定义 |
|------|------|
| 真实数据库 | 本期指通过 POSTGRES_URL 配置的 PostgreSQL，数据持久化到磁盘，重启不丢失 |
| 内存数据 | 进程内变量或占位数据，重启后重置 |
| 用户-项目关联 | 项目记录所属用户（如 userId），用于权限与数据隔离 |

### 8.2 参考资料

- `openspec/project.md`（修改前/后）
- `app/lib/auth.ts`、`app/lib/projects.ts`、`app/lib/placeholder-data.ts`
- 现有 API：`app/api/` 下与登录、注册、项目相关的 route
